name: Build & Deploy Docs Site (Quartz -> Skill gh-pages)

on:
  push:
    branches: [ "main" ]
    tags: [ "v*.*.*" ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout Demo (this repo)
      - name: Checkout Demo repo
        uses: actions/checkout@v4
        with:
          path: _ws/demo

      # 2) Checkout Quartz (engine)
      - name: Checkout Quartz repo
        uses: actions/checkout@v4
        with:
          repository: jackyzha0/quartz
          path: _ws/quartz
          # Pin to stable version to avoid breaking changes
          ref: v4.4.0

      # 3) Checkout Skill repo (main) as source
      - name: Checkout Skill repo (source)
        uses: actions/checkout@v4
        with:
          repository: dorgonman/kano-agent-backlog-skill
          path: _ws/skill
          token: ${{ secrets.SKILL_REPO_TOKEN }}

      # 4) Checkout Skill repo (gh-pages) as deployment target
      - name: Checkout Skill repo (gh-pages target)
        uses: actions/checkout@v4
        with:
          repository: dorgonman/kano-agent-backlog-skill
          ref: gh-pages
          path: _ws/skill-pages
          token: ${{ secrets.SKILL_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: 'npm'
          cache-dependency-path: '_ws/quartz/package-lock.json'

      # 5) Cook: select and organize docs -> _ws/content
      - name: Cook docs into Quartz content
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _ws/content

          # Content selection policy:
          # - Demo docs from _ws/demo/docs
          # - Skill docs from _ws/skill/docs  
          # - Main README as landing page
          # TODO: Implement manifest-based filtering for production

          if [ -d "_ws/demo/docs" ]; then
            echo "Copying demo docs..."
            rsync -av --delete "_ws/demo/docs/" "_ws/content/demo/"
          fi

          if [ -d "_ws/skill/docs" ]; then
            echo "Copying skill docs..."
            rsync -av --delete "_ws/skill/docs/" "_ws/content/skill/"
          fi

          # Use skill README as landing page
          if [ -f "_ws/skill/README.md" ]; then
            echo "Setting up landing page..."
            cp "_ws/skill/README.md" "_ws/content/index.md"
          fi

          # Copy skill SKILL.md as main documentation
          if [ -f "_ws/skill/SKILL.md" ]; then
            echo "Copying SKILL.md..."
            cp "_ws/skill/SKILL.md" "_ws/content/skill-guide.md"
          fi

      # 6) Build Quartz site
      - name: Install Quartz dependencies
        shell: bash
        working-directory: _ws/quartz
        run: |
          set -euo pipefail
          npm ci

      - name: Build static site with Quartz
        shell: bash
        working-directory: _ws/quartz
        run: |
          set -euo pipefail
          npx quartz build --directory ../content --output ../public

      # 7) Deploy: overwrite gh-pages content and push
      - name: Deploy to gh-pages branch
        shell: bash
        run: |
          set -euo pipefail

          # Clear target directory (preserve .git)
          find _ws/skill-pages -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          # Copy built site to deployment target
          rsync -av "_ws/public/" "_ws/skill-pages/"

          # Configure git and commit changes
          cd _ws/skill-pages
          git config user.name "docs-bot"
          git config user.email "docs-bot@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy."
            exit 0
          fi

          git commit -m "Deploy docs site from ${GITHUB_REPOSITORY}@${GITHUB_SHA}"
          git push origin gh-pages