name: Build & Deploy Docs Site (Quartz -> Skill gh-pages)

on:
  push:
    tags: [ "v*.*.*" ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout Demo repo (minimal - only docs and scripts)
      - name: Checkout Demo repo
        uses: actions/checkout@v4
        with:
          path: _ws/src/demo
          sparse-checkout: |
            README.md
            AGENTS.md
            CLAUDE.md
            docs/
            scripts/docs/
            _kano/backlog/products/kano-agent-backlog-skill/decisions/
          sparse-checkout-cone-mode: false

      # Read configuration
      - name: Read deployment configuration
        id: config
        run: |
          QUARTZ_VERSION=$(grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' _ws/src/demo/scripts/docs/config/build.json | cut -d'"' -f4)
          NODE_VERSION=$(grep -A5 '"build"' _ws/src/demo/scripts/docs/config/build.json | grep -o '"node_version"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
          echo "quartz_version=$QUARTZ_VERSION" >> $GITHUB_OUTPUT
          echo "node_version=$NODE_VERSION" >> $GITHUB_OUTPUT
          echo "Using Quartz version: $QUARTZ_VERSION"
          echo "Using Node.js version: $NODE_VERSION"

      # 2) Checkout Quartz (engine)
      - name: Checkout Quartz repo
        uses: actions/checkout@v4
        with:
          repository: jackyzha0/quartz
          path: _ws/src/quartz
          ref: ${{ steps.config.outputs.quartz_version }}

      # 3) Checkout Skill repo (main) as source
      - name: Checkout Skill repo (source)
        uses: actions/checkout@v4
        with:
          repository: dorgonman/kano-agent-backlog-skill
          path: _ws/src/skill
          token: ${{ secrets.SKILL_REPO_TOKEN }}

      # 4) Checkout Skill repo (gh-pages) as deployment target
      - name: Checkout Skill repo (gh-pages target)
        uses: actions/checkout@v4
        with:
          repository: dorgonman/kano-agent-backlog-skill
          ref: gh-pages
          path: _ws/deploy/gh-pages
          token: ${{ secrets.SKILL_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.config.outputs.node_version }}
          cache: 'npm'
          cache-dependency-path: '_ws/src/quartz/package-lock.json'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install mkdocs mkdocs-material mkdocstrings[python] pyyaml

      - name: Install kano-backlog CLI (from skill repo)
        run: |
          pip install -e _ws/src/skill

      # 5) Build and deploy documentation site
      - name: Build and deploy documentation site
        shell: bash
        run: |
          chmod +x _ws/src/demo/scripts/docs/build-and-deploy.sh
          # Use unified script with CI mode
          _ws/src/demo/scripts/docs/build-and-deploy.sh --ci "$(pwd)"
